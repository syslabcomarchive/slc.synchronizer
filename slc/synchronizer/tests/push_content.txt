Push content
===============

This doctest gives an overview about pushing content to be synchronized.

Setting up
----------

    >>> from DateTime import DateTime

    Create a RiskAssessmentLink
    >>> _ = folder.invokeFactory(id='myralink', type_name='RiskAssessmentLink')
    >>> ralink = folder[_]
    >>> ralink.unmarkCreationFlag()
    >>> ralink.id
    'myralink'
    
    Give it a fake UID
    >>> ralink._at_uid = '1'
    
    Create a Provider
    >>> _ = folder.invokeFactory(id='myprovider', type_name="Provider")
    >>> rp = folder[_]
    
    Create some data
    >>> mydata = dict(id='myralink', title='ratitle', description='radescription', remoteUrl='http://remote', 
    ...   dateOfEditing='2004-08-01', dateOfEditing_year='2004', dateOfEditing_month='08', dateOfEditing_day='01',
    ...   contents='racontents', remarks='raremarks', nace=['01', '05'],
    ...   riskfactors=['rariskfactors'], remoteProvider=rp)
    >>> ralink.processForm(data=1, values=mydata)
    
    
    
    
    Mockup class that provides interface functionality of the receiving end
    >>> class XMLRPCProxy(object):
    ...   UIDS = dict()
    ...     #{'1' :('2008/09/03', 'http://osha.europa.eu/myralink')}
    ...   def __init__(self, id):
    ...     self.id = id
    ...
    ...   def getSyncStatus(self, remote_uid):
    ...     """ looks up the remote uid in the local utility to get the local uid.
    ...     resolves the object using the local uid
    ...     returns the modification date of the referenced object or None, if no such object exists
    ...     as well as the link of the object"""
    ...     return self.UIDS.get(remote_uid, (None, None))
    ...
    ...   def syncObject(self, portal_type, data={}, remote_uid=None):
    ...     """ check if an object to the given remote_uid exists
    ...     if not, create one using the portal_type
    ...     update its data using the data mapping
    ...     returns a feedback message and the link of the object in question """
    ...     if self.UIDS.has_key(remote_uid):
    ...       msg = 'Object was modified'
    ...       date = self.UIDS[remote_uid][0]
    ...     else:
    ...       msg = 'Object was created'
    ...       date = 0
    ...     link = 'http://osha.europa.eu/%s/%s' %(portal_type, data['id'])
    ...     self.UIDS[remote_uid] = (date + 1, link)
    ...     return msg, link
    
    Initialize XMLRPCProxy
    >>> proxy = XMLRPCProxy('proxy')
    >>> proxy.getSyncStatus('1')
    (None, None)
    


Testing the connection
----------------------
    
    Get the BrowserView that handles synchronisation
    >>> bv = ralink.restrictedTraverse('synchronize_content')
    >>> bv.setProxy(proxy)
    
    Our RiskAssessmentLink has never been synchronized before:
    >>> bv.getRAStatus()
    (None, None)
    
    Now we synchronize for the first time
    >>> proxy.syncObject('RiskAssessmentLink', {'id': ralink.id}, ralink.UID())
    ('Object was created', 'http://osha.europa.eu/RiskAssessmentLink/myralink')
    
    So now we have a status:
    >>> bv.getRAStatus()
    (1, 'http://osha.europa.eu/RiskAssessmentLink/myralink')
    
    We synchronize again
    >>> proxy.syncObject('RiskAssessmentLink', {'id': ralink.id}, ralink.UID())
    ('Object was modified', 'http://osha.europa.eu/RiskAssessmentLink/myralink')

    And the status returns a 'newer' date
    >>> bv.getRAStatus()
    (2, 'http://osha.europa.eu/RiskAssessmentLink/myralink')

    >>> data = bv.getRAData()

