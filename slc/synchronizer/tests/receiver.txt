========================
Synchronization Receiver
========================

This component provides an XMLRPC endpoint which can receive data that is 
necessary to create or edit a new object as well as return status information.

    >>> from zope.app.component.hooks import getSite
    >>> portal = layer['portal']
    >>> folder = portal.folder

Every folderish object can be used as a bridgehead to call the synchronizer mechanism.
    
    >>> from zope.component import getAdapter, getMultiAdapter
    >>> from slc.synchronizer.interfaces import IReceiver
    >>> portal_objects_before = len(portal.objectIds())

First a remote site will usually call getSyncStatus, so find out if an object
already has been synced. We have not synced anything yet, so the return will be None

    >>> receiver = getMultiAdapter((portal, portal.REQUEST), name=u"synchronize_receiver")
    >>> receiver.getSyncStatus('sourcesite', 'REMOTEUID') 
    (-1, -1)
    
Next, we assume the receiver gets called with the data to add a new document. 
Currently there are no translations for that document. It should return the link 
to the new object

    >>> from plone.app.testing import login, setRoles, TEST_USER_ID, TEST_USER_NAME
    >>> setRoles(portal, TEST_USER_ID, ['Manager'])
    >>> login(portal, TEST_USER_NAME)
    >>> result = receiver.syncObject(portal_type="Document", 
    ...                              data={'id': 'synctest', 
    ...                                    'title': 'Synced Title', 
    ...                                    'description': 'Synced Description'}, 
    ...                              site_id='sourcesite', 
    ...                              remote_uid='REMOTEUID', 
    ...                              translation_reference_uid=None)
    >>> result[0]
    0
    >>> result[1]
    'Object created successfully'
    >>> result[2]
	'http://nohost/plone/synctest'
	
And finally the object has been created.

    >>> obj_id = result[2].split('/')[-1]
    >>> obj_id in portal.objectIds()
    True

If the sync status is now called for the same object, it will return the 
modification date of the now existing object.

    >>> receiver.getSyncStatus('sourcesite', 'REMOTEUID') == (-1, -1)
    False
    
If the object is now synced again, it will not be created anew but the existing 
object will be edited.

    >>> len(portal.objectIds()) - portal_objects_before
    1
    >>> result = receiver.syncObject(portal_type="Document", 
    ...                              data={'id': 'synctest', 
    ...                                    'title': 'ReSynced Title', 
    ...                                    'description': 'ReSynced Description'}, 
    ...                              site_id='sourcesite',
    ...                              remote_uid='REMOTEUID', 
    ...                              translation_reference_uid=None)
    >>> len(portal.objectIds()) - portal_objects_before
    1
    >>> ob = getattr(folder, obj_id, None)
    >>> ob.Title()
    'ReSynced Title'
    >>> ob.Description()
    'ReSynced Description'

    >>> from Products.CMFCore.utils import getToolByName
    >>> catalog = getToolByName(portal, 'portal_catalog')
   
    How many Items do we have now
    >>> before = len(catalog.searchResults())
    >>> doc = folder.invokeFactory('Document', 'Document')

    We added a Document, it should be in the search results too!
    >>> len(catalog.searchResults()) - before
    1
